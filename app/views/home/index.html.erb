<!-- Header con título y botón -->
<div class="d-flex justify-content-between align-items-center mb-4">
  <h1 class="h3 mb-0 fw-bold">MOSTRADOR</h1>
  <%= link_to root_path, class: "btn btn-primary" do %>
    + Nuevo Pedido
  <% end %>
</div>

<div class="row g-4">
  <!-- Columna Derecha: Formulario NUEVO PEDIDO o Detalle de Pedido (primero en móvil) -->
  <% if @new_order_id.present? && @current_order.present? %>
    <div class="col-lg-4 order-1 order-lg-2">
      <div class="card border-0 shadow-sm">
        <!-- Header con ID y botones -->
        <div class="card-header bg-warning text-white d-flex justify-content-between align-items-center">
          <h5 class="mb-0 fw-bold">ID #<%= @current_order.id %></h5>
          <div>
            <button class="btn btn-sm btn-light me-2" type="button" title="Confirmar">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-check-square" viewBox="0 0 16 16">
                <path d="M14 1a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1zM2 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2z"/>
                <path d="M10.97 4.97a.75.75 0 0 1 1.07 1.05l-3.99 4.99a.75.75 0 0 1-1.08.02L4.324 8.384a.75.75 0 1 1 1.06-1.06l2.094 2.093 3.473-4.425z"/>
              </svg>
            </button>
            <button class="btn btn-sm btn-light" type="button" title="Editar">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-pencil" viewBox="0 0 16 16">
                <path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168zM11.207 2.5 13.5 4.793 14.793 3.5 12.5 1.207zm1.586 3L10.5 9.207 2.5 1.207l3.707 3.707L12.793 5.5z"/>
              </svg>
            </button>
          </div>
        </div>

        <div class="card-body">
          <!-- Mensajes de éxito/error -->
          <% if notice %>
            <div class="alert alert-success alert-dismissible fade show" role="alert">
              <%= notice %>
              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
          <% end %>

          <% if alert %>
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
              <%= alert %>
              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
          <% end %>

          <!-- Información del pedido -->
          <div class="mb-3">
            <div class="mb-2">
              <strong>Hora Inicio:</strong> <%= @current_order.created_at.strftime("%d/%m/%y %H:%M:%S") %>
            </div>
            <div>
              <strong>Seguimiento:</strong> 
              <a href="#" class="text-decoration-none" data-bs-toggle="modal" data-bs-target="#orderDetailModal">
                Ver pedido
                <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" class="bi bi-box-arrow-up-right" viewBox="0 0 16 16">
                  <path fill-rule="evenodd" d="M8.636 3.5a.5.5 0 0 0-.5-.5H1.5A1.5 1.5 0 0 0 0 4.5v10A1.5 1.5 0 0 0 1.5 16h10a1.5 1.5 0 0 0 1.5-1.5V7.864a.5.5 0 0 0-1 0V14.5a.5.5 0 0 1-.5.5h-10a.5.5 0 0 1-.5-.5v-10a.5.5 0 0 1 .5-.5h6.636a.5.5 0 0 0 .5-.5"/>
                  <path fill-rule="evenodd" d="M16 .5a.5.5 0 0 0-.5-.5h-5a.5.5 0 0 0 0 1h3.793L6.146 9.146a.5.5 0 1 0 .708.708L15 1.707V5.5a.5.5 0 0 0 1 0z"/>
                </svg>
              </a>
            </div>
          </div>

          <!-- Sección ADICIONAR -->
          <div class="bg-secondary text-white p-2 mb-3 d-flex justify-content-between align-items-center">
            <span class="fw-bold">ADICIONAR</span>
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-gear" viewBox="0 0 16 16">
              <path d="M8 4.754a3.246 3.246 0 1 0 0 6.492 3.246 3.246 0 0 0 0-6.492M5.754 8a2.246 2.246 0 1 1 4.492 0 2.246 2.246 0 0 1-4.492 0"/>
              <path d="M9.796 1.343c-.527-1.79-3.065-1.79-3.592 0l-.094.319a.873.873 0 0 1-1.255.52l-.292-.16c-1.64-.892-3.433.902-2.54 2.541l.159.292a.873.873 0 0 1-.52 1.255l-.319.094c-1.79.527-1.79 3.065 0 3.592l.319.094a.873.873 0 0 1 .52 1.255l-.16.292c-.892 1.64.901 3.434 2.541 2.54l.292-.159a.873.873 0 0 1 1.255.52l.094.319c.527 1.79 3.065 1.79 3.592 0l.094-.319a.873.873 0 0 1 1.255-.52l.292.16c1.64.893 3.434-.902 2.54-2.541l-.159-.292a.873.873 0 0 1 .52-1.255l.319-.094c1.79-.527 1.79-3.065 0-3.592l-.319-.094a.873.873 0 0 1-.52-1.255l.16-.292c.893-1.64-.902-3.433-2.541-2.54l-.292.159a.873.873 0 0 1-1.255-.52zm-2.633.283c.246-.835 1.428-.835 1.674 0l.094.319a1.873 1.873 0 0 0 2.693 1.115l.292-.16c.764-.415 1.6.42 1.184 1.185l-.159.292a1.873 1.873 0 0 0 1.116 2.692l.318.094c.835.246.835 1.428 0 1.674l-.319.094a1.873 1.873 0 0 0-1.115 2.693l.16.292c.415.764-.42 1.6-1.185 1.184l-.292-.159a1.873 1.873 0 0 0-2.693 1.116l-.094.318c-.246.835-1.428.835-1.674 0l-.094-.319a1.873 1.873 0 0 0-2.692-1.115l-.292.16c-.764.415-1.6-.42-1.184-1.185l.159-.292A1.873 1.873 0 0 0 1.945 8.93l-.319-.094c-.835-.246-.835-1.428 0-1.674l.319-.094A1.873 1.873 0 0 0 3.06 4.377l-.16-.292c-.415-.764.42-1.6 1.185-1.184l.292.159a1.873 1.873 0 0 0 2.692-1.115z"/>
            </svg>
          </div>

          <!-- Mensaje si el pedido está cerrado -->
          <% if @current_order.status != 0 %>
            <div class="alert alert-warning mb-3" role="alert">
              <strong>Pedido cerrado:</strong> No se pueden agregar más productos a este pedido.
            </div>
          <% end %>

          <!-- Productos confirmados en la orden -->
          <% if @order_items.present? && @order_items.any? %>
            <div class="mb-3">
              <h6 class="fw-bold mb-2">Productos confirmados:</h6>
              <div style="max-height: 150px; overflow-y: auto;">
                <% @order_items.each do |item| %>
                  <div class="d-flex justify-content-between align-items-center mb-2 p-2 bg-light rounded">
                    <div class="flex-grow-1">
                      <div class="fw-bold"><%= item.product.nombre %></div>
                      <small class="text-muted">Cant: <%= item.cantidad %> x $<%= sprintf("%.2f", item.precio_unitario) %></small>
                      <% if item.comentario.present? %>
                        <div class="mt-1">
                          <small class="text-info"><em><%= item.comentario %></em></small>
                        </div>
                      <% end %>
                    </div>
                    <div class="fw-bold">$<%= sprintf("%.2f", item.subtotal) %></div>
                  </div>
                <% end %>
              </div>
            </div>
          <% end %>

          <!-- Productos seleccionados (temporales) -->
          <div id="selectedProductsContainer" class="mb-3" style="display: none;">
            <h6 class="fw-bold mb-2">Productos seleccionados:</h6>
            <div id="selectedProductsList" style="max-height: 200px; overflow-y: auto;">
              <!-- Los productos seleccionados se agregarán aquí dinámicamente -->
            </div>
          </div>

          <!-- Búsqueda de productos -->
          <% if @current_order.status == 0 %>
            <div class="mb-3">
              <input type="text" id="productSearch" class="form-control" placeholder="Buscar producto...">
            </div>

            <!-- Grid de productos dinámicos -->
            <div class="row g-2 mb-3" id="productsGrid" style="max-height: 300px; overflow-y: auto;">
              <% if @products.present? %>
                <% @products.each do |product| %>
                  <div class="col-6 product-item" data-product-id="<%= product.id %>" data-product-name="<%= product.nombre.downcase %>" data-product-precio="<%= product.precio %>">
                    <button type="button" class="btn btn-light w-100 text-start add-product-btn" 
                            data-product-id="<%= product.id %>" 
                            data-product-name="<%= product.nombre %>"
                            data-product-precio="<%= product.precio %>">
                      <%= truncate(product.nombre, length: 20) %>
                    </button>
                  </div>
                <% end %>
              <% else %>
                <div class="col-12 text-center text-muted py-3">
                  No hay productos disponibles.
                </div>
              <% end %>
            </div>
          <% end %>
        </div>

        <!-- Footer con Total y botones -->
        <div class="card-footer bg-dark text-white p-2">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <span class="fw-bold">Total confirmado:</span>
            <span class="fw-bold">$<%= sprintf("%.2f", @current_order.total) %></span>
          </div>
          <div class="d-flex justify-content-between align-items-center mb-2" id="selectedTotalContainer" style="display: none;">
            <span class="fw-bold">Total seleccionado:</span>
            <span class="fw-bold" id="selectedTotal">$0.00</span>
          </div>
          <div class="d-grid gap-2">
            <% if @current_order.status == 0 %>
              <%= form_with url: confirm_items_order_path(@current_order), method: :post, local: true, data: { turbo: false }, id: "confirmProductsForm", class: "d-inline" do |f| %>
                <button type="submit" id="confirmProductsBtn" class="btn btn-warning fw-bold w-100" disabled>
                  Confirmar Productos
                </button>
              <% end %>
              <button type="button" class="btn btn-dark border w-100" data-bs-toggle="modal" data-bs-target="#closeOrderModal">
                Cerrar Pedido
              </button>
            <% else %>
              <div class="alert alert-info mb-0" role="alert">
                <strong>Pedido cerrado</strong> - No se pueden realizar más modificaciones
              </div>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  <% else %>
    <div class="col-lg-4 order-1 order-lg-2">
      <div class="card border-0 shadow-sm">
        <div class="card-header bg-warning">
          <h5 class="mb-0 fw-bold">NUEVO PEDIDO</h5>
        </div>
        <div class="card-body">
          <% if notice %>
            <div class="alert alert-success alert-dismissible fade show" role="alert">
              <%= notice %>
              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
          <% end %>
          <% if alert %>
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
              <%= alert %>
              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
          <% end %>
          
          <%= form_with url: orders_path, method: :post, local: true, data: { turbo: false }, class: "needs-validation", novalidate: true do |f| %>
            <div class="mb-3">
              <%= f.label :cliente, "Cliente", class: "form-label" %>
              <%= f.text_field :cliente, class: "form-control", placeholder: "Nombre del cliente", required: true %>
            </div>

            <div class="mb-3">
              <%= f.label :mesero, "Mesero", class: "form-label" %>
              <%= f.select :mesero, 
                  options_for_select([
                    ["Seleccionar mesero...", ""],
                    ["Mesero 1", "mesero1"],
                    ["Mesero 2", "mesero2"],
                    ["Mesero 3", "mesero3"]
                  ]), 
                  {}, 
                  { class: "form-select", required: true } %>
            </div>

            <div class="mb-3">
              <%= f.label :comentario, "Comentario", class: "form-label" %>
              <%= f.text_area :comentario, class: "form-control", rows: 4, placeholder: "Comentarios adicionales..." %>
            </div>

            <div class="d-grid">
              <%= f.submit "Crear", class: "btn btn-warning fw-bold" %>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  <% end %>

  <!-- Columna Izquierda: Tablas de Pedidos (segundo en móvil) -->
  <div class="col-lg-8 order-2 order-lg-1">
    <!-- Tabla EN CURSO -->
    <div class="card mb-4">
      <div class="card-header bg-light">
        <h5 class="mb-0 fw-bold">EN CURSO</h5>
      </div>
      <div class="card-body p-0">
        <table class="table table-hover mb-0">
          <thead class="table-light">
            <tr>
              <th>ID</th>
              <th>Hora Inicio</th>
              <th>Estado</th>
              <th>Cliente</th>
              <th>Total</th>
            </tr>
          </thead>
          <tbody>
            <% if @orders.present? %>
              <% @orders.each do |order| %>
                <tr style="cursor: pointer;" data-order-id="<%= order.id %>" class="order-row">
                  <td><%= order.id %></td>
                  <td><%= order.created_at.strftime("%d/%m/%Y %H:%M:%S") %></td>
                  <td><span class="bg-success text-white fw-bold p-1 rounded">En curso</span></td>
                  <td><%= order.cliente %></td>
                  <td>$<%= sprintf("%.2f", order.total) %></td>
                </tr>
              <% end %>
            <% else %>
              <tr>
                <td colspan="5" class="text-center text-muted py-4">
                  Sin ventas en curso.
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Tabla CERRADAS -->
    <div class="card">
      <div class="card-header bg-light">
        <h5 class="mb-0 fw-bold">CERRADAS (ÚLTIMAS 5)</h5>
      </div>
      <div class="card-body p-0">
        <table class="table table-hover mb-0">
          <thead class="table-light">
            <tr>
              <th>ID</th>
              <th>Hora Inicio</th>
              <th>Estado</th>
              <th>Cliente</th>
              <th>Total</th>
            </tr>
          </thead>
          <tbody>
            <% if @closed_orders.present? %>
              <% @closed_orders.each do |order| %>
                <tr class="border-start">
                  <td class="fw-bold"><%= order.id %></td>
                  <td><%= order.created_at.strftime("%d/%m/%y %H:%M:%S") %></td>
                  <td><span class="bg-danger text-white fw-bold p-1 rounded">Cerrada</span></td>
                  <td><%= order.cliente %></td>
                  <td class="fw-bold">$<%= sprintf("%.2f", order.total) %></td>
                </tr>
              <% end %>
            <% else %>
              <tr>
                <td colspan="5" class="text-center text-muted py-4">
                  No hay pedidos cerrados.
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Modal para cerrar pedido -->
<% if @current_order.present? && @current_order.status == 0 %>
<div class="modal fade" id="closeOrderModal" tabindex="-1" aria-labelledby="closeOrderModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg">
      <div class="modal-header bg-warning text-white">
        <h5 class="modal-title fw-bold" id="closeOrderModalLabel">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-cash-coin me-2" viewBox="0 0 16 16">
            <path d="M1 0a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h4.11a.5.5 0 0 1 .494.379l1.7 6.8A.5.5 0 0 0 8.5 17h5a.5.5 0 0 0 .494-.379l1.7-6.8A.5.5 0 0 1 15.39 10H16a1 1 0 0 0 1-1V1a1 1 0 0 0-1-1zM0 1v8h4.11l1.7 6.8A.5.5 0 0 0 6.5 16h5a.5.5 0 0 0 .494-.379L13.39 9H16V1z"/>
          </svg>
          Cerrar Pedido #<%= @current_order.id %>
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <%= form_with url: close_order_order_path(@current_order), method: :post, local: true, data: { turbo: false }, id: "closeOrderForm" do |f| %>
        <div class="modal-body">
          <!-- Total del pedido -->
          <div class="card bg-light mb-3">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center">
                <span class="fw-bold fs-5">Total a pagar:</span>
                <span class="fw-bold fs-4 text-warning" id="orderTotal">$<%= sprintf("%.2f", @current_order.total) %></span>
              </div>
            </div>
          </div>

          <!-- Tipo de pago -->
          <div class="mb-3">
            <label class="form-label fw-bold">Tipo de pago</label>
            <div class="btn-group w-100" role="group">
              <input type="radio" class="btn-check" name="tipo_pago" id="tipo_efectivo" value="efectivo" checked>
              <label class="btn btn-outline-warning" for="tipo_efectivo">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-cash me-1" viewBox="0 0 16 16">
                  <path d="M8 10a2 2 0 1 0 0-4 2 2 0 0 0 0 4"/>
                  <path d="M0 4a1 1 0 0 1 1-1h13a1 1 0 0 1 1 1v6a1 1 0 0 1-1 1H1a1 1 0 0 1-1-1zm3 8a2 2 0 1 0 0-4 2 2 0 0 0 0 4"/>
                  <path d="M0 10.5a1.5 1.5 0 0 0 1.5 1.5h13a1.5 1.5 0 0 0 1.5-1.5v-3a1.5 1.5 0 0 0-1.5-1.5h-13a1.5 1.5 0 0 0-1.5 1.5z"/>
                </svg>
                Efectivo
              </label>
              <input type="radio" class="btn-check" name="tipo_pago" id="tipo_transferencia" value="transferencia">
              <label class="btn btn-outline-warning" for="tipo_transferencia">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-bank me-1" viewBox="0 0 16 16">
                  <path d="m8 0 6.61 3h.89a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-.5.5H15v7a.5.5 0 0 1 .485.38l.5 2a.498.498 0 0 1-.485.62H.5a.498.498 0 0 1-.485-.62l.5-2A.5.5 0 0 1 1 13V6H.5a.5.5 0 0 1-.5-.5v-2A.5.5 0 0 1 .5 3h.89zM3.777 3h8.447L8 1zM2 6v7h1V6zm2 0v7h2.5V6zm3.5 0v7h1V6zm2 0v7H12V6zm3 0v7h1V6zM1 4v1h14V4z"/>
                </svg>
                Transferencia
              </label>
            </div>
          </div>

          <!-- Monto pagado -->
          <div class="mb-3">
            <label for="monto_pagado" class="form-label fw-bold">Monto recibido</label>
            <div class="input-group input-group-lg">
              <span class="input-group-text bg-warning text-white fw-bold">$</span>
              <input type="number" 
                     class="form-control" 
                     id="monto_pagado" 
                     name="monto_pagado" 
                     step="0.01" 
                     min="0" 
                     required
                     value="<%= sprintf("%.2f", @current_order.total) %>">
            </div>
            <small class="text-muted">Ingrese el monto con el que le pagaron</small>
          </div>

          <!-- Vuelto (calculado automáticamente) -->
          <div class="mb-3" id="vueltoContainer" style="display: none;">
            <div class="card border-success" id="vueltoCard">
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                  <span class="fw-bold" id="vueltoLabel">Vuelto a devolver:</span>
                  <span class="fw-bold fs-4" id="vueltoAmount">$0.00</span>
                </div>
              </div>
            </div>
          </div>

          <input type="hidden" id="vuelto" name="vuelto" value="0">
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-warning fw-bold">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-check-circle me-1" viewBox="0 0 16 16">
              <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"/>
              <path d="m10.97 4.97-.02.022a.75.75 0 1 1-1.08 1.04L6.477 9.417 4.384 7.323a.75.75 0 0 1 1.06-1.06l2.094 2.093 3.473-4.425z"/>
            </svg>
            Cerrar Pedido
          </button>
        </div>
      <% end %>
    </div>
  </div>
</div>
<% end %>

<!-- Modal para ver detalle del pedido -->
<% if @current_order.present? %>
<div class="modal fade" id="orderDetailModal" tabindex="-1" aria-labelledby="orderDetailModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg">
      <div class="modal-header bg-warning text-white">
        <h5 class="modal-title fw-bold" id="orderDetailModalLabel">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-receipt me-2" viewBox="0 0 16 16">
            <path d="M1.92.506a.5.5 0 0 1 .434.14L3 1.293l.646-.647a.5.5 0 0 1 .708 0L5 1.293l.646-.647a.5.5 0 0 1 .708 0L7 1.293l.646-.647a.5.5 0 0 1 .708 0L9 1.293l.646-.647a.5.5 0 0 1 .708 0l.646.647.646-.647a.5.5 0 0 1 .708 0l.646.647.646-.647a.5.5 0 0 1 .801.13l.5 1A.5.5 0 0 1 15 2v12a.5.5 0 0 1-.053.224l-.5 1a.5.5 0 0 1-.8.13L13 14.707l-.646.647a.5.5 0 0 1-.708 0L11 14.707l-.646.647a.5.5 0 0 1-.708 0L9 14.707l-.646.647a.5.5 0 0 1-.708 0L7 14.707l-.646.647a.5.5 0 0 1-.708 0L5 14.707l-.646.647a.5.5 0 0 1-.708 0L3 14.707l-.646.647a.5.5 0 0 1-.801-.13l-.5-1A.5.5 0 0 1 1 14V2a.5.5 0 0 1 .053-.224l.5-1a.5.5 0 0 1 .367-.27zm.217 1.338L2 2.118v11.764l.137.274.51-.51a.5.5 0 0 1 .707 0l.646.647.646-.646a.5.5 0 0 1 .708 0l.646.646.646-.646a.5.5 0 0 1 .708 0l.646.646.646-.646a.5.5 0 0 1 .708 0l.646.646.646-.646a.5.5 0 0 1 .708 0l.509.509.137-.274V2.118l-.137-.274-.51.51a.5.5 0 0 1-.707 0L12 1.707l-.646.647a.5.5 0 0 1-.708 0L10 1.707l-.646.647a.5.5 0 0 1-.708 0L8 1.707l-.646.647a.5.5 0 0 1-.708 0L6 1.707l-.646.647a.5.5 0 0 1-.708 0L4 1.707l-.646.647a.5.5 0 0 1-.708 0l-.509-.509z"/>
            <path d="M3 4.5a.5.5 0 0 1 .5-.5h6a.5.5 0 1 1 0 1h-6a.5.5 0 0 1-.5-.5m0 2a.5.5 0 0 1 .5-.5h6a.5.5 0 1 1 0 1h-6a.5.5 0 0 1-.5-.5m0 2a.5.5 0 0 1 .5-.5h6a.5.5 0 1 1 0 1h-6a.5.5 0 0 1-.5-.5m0 2a.5.5 0 0 1 .5-.5h6a.5.5 0 1 1 0 1h-6a.5.5 0 0 1-.5-.5m8-6a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 0 1h-1a.5.5 0 0 1-.5-.5m0 2a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 0 1h-1a.5.5 0 0 1-.5-.5m0 2a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 0 1h-1a.5.5 0 0 1-.5-.5m0 2a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 0 1h-1a.5.5 0 0 1-.5-.5"/>
          </svg>
          Detalle del Pedido #<%= @current_order.id %>
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <!-- Información del pedido -->
        <div class="card bg-light mb-3">
          <div class="card-body">
            <div class="row">
              <div class="col-md-6 mb-2">
                <strong>Cliente:</strong> <%= @current_order.cliente || 'Sin cliente' %>
              </div>
              <div class="col-md-6 mb-2">
                <strong>Mesero:</strong> <%= @current_order.mesero || 'Sin mesero' %>
              </div>
              <div class="col-md-6 mb-2">
                <strong>Fecha de creación:</strong> <%= @current_order.created_at.strftime("%d/%m/%Y %H:%M:%S") %>
              </div>
              <div class="col-md-6 mb-2">
                <strong>Estado:</strong> 
                <% if @current_order.status == 0 %>
                  <span class="bg-success text-white fw-bold p-1 rounded">En curso</span>
                <% else %>
                  <span class="bg-danger text-white fw-bold p-1 rounded">Cerrada</span>
                <% end %>
              </div>
              <% if @current_order.comentario.present? %>
                <div class="col-12 mt-2">
                  <strong>Comentario del pedido:</strong>
                  <p class="mb-0 text-muted"><%= @current_order.comentario %></p>
                </div>
              <% end %>
            </div>
          </div>
        </div>

        <!-- Productos del pedido -->
        <div class="mb-3">
          <h6 class="fw-bold mb-3">Productos:</h6>
          <% if @order_items.present? && @order_items.any? %>
            <div class="table-responsive">
              <table class="table table-hover">
                <thead class="table-light">
                  <tr>
                    <th>Producto</th>
                    <th class="text-center">Cantidad</th>
                    <th class="text-end">Precio Unit.</th>
                    <th class="text-end">Subtotal</th>
                  </tr>
                </thead>
                <tbody>
                  <% @order_items.each do |item| %>
                    <tr>
                      <td>
                        <div class="fw-bold"><%= item.product.nombre %></div>
                        <% if item.comentario.present? %>
                          <small class="text-muted"><em><%= item.comentario %></em></small>
                        <% end %>
                      </td>
                      <td class="text-center"><%= item.cantidad %></td>
                      <td class="text-end">$<%= sprintf("%.2f", item.precio_unitario) %></td>
                      <td class="text-end fw-bold">$<%= sprintf("%.2f", item.subtotal) %></td>
                    </tr>
                  <% end %>
                </tbody>
              </table>
            </div>
          <% else %>
            <div class="alert alert-info mb-0">
              No hay productos en este pedido.
            </div>
          <% end %>
        </div>

        <!-- Información de pago (solo si está cerrado) -->
        <% if @current_order.status == 1 && @current_order.monto_pagado.present? %>
          <div class="card border-warning mb-3">
            <div class="card-header bg-warning text-white">
              <h6 class="mb-0 fw-bold">Información de Pago</h6>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-4 mb-2">
                  <strong>Tipo de pago:</strong>
                  <div>
                    <% if @current_order.tipo_pago == 'efectivo' %>
                      <span class="badge bg-success">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-cash" viewBox="0 0 16 16">
                          <path d="M8 10a2 2 0 1 0 0-4 2 2 0 0 0 0 4"/>
                          <path d="M0 4a1 1 0 0 1 1-1h13a1 1 0 0 1 1 1v6a1 1 0 0 1-1 1H1a1 1 0 0 1-1-1zm3 8a2 2 0 1 0 0-4 2 2 0 0 0 0 4"/>
                          <path d="M0 10.5a1.5 1.5 0 0 0 1.5 1.5h13a1.5 1.5 0 0 0 1.5-1.5v-3a1.5 1.5 0 0 0-1.5-1.5h-13a1.5 1.5 0 0 0-1.5 1.5z"/>
                        </svg>
                        Efectivo
                      </span>
                    <% else %>
                      <span class="badge bg-primary">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-bank" viewBox="0 0 16 16">
                          <path d="m8 0 6.61 3h.89a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-.5.5H15v7a.5.5 0 0 1 .485.38l.5 2a.498.498 0 0 1-.485.62H.5a.498.498 0 0 1-.485-.62l.5-2A.5.5 0 0 1 1 13V6H.5a.5.5 0 0 1-.5-.5v-2A.5.5 0 0 1 .5 3h.89zM3.777 3h8.447L8 1zM2 6v7h1V6zm2 0v7h2.5V6zm3.5 0v7h1V6zm2 0v7H12V6zm3 0v7h1V6zM1 4v1h14V4z"/>
                        </svg>
                        Transferencia
                      </span>
                    <% end %>
                  </div>
                </div>
                <div class="col-md-4 mb-2">
                  <strong>Monto pagado:</strong>
                  <div class="fw-bold text-success">$<%= sprintf("%.2f", @current_order.monto_pagado) %></div>
                </div>
                <% if @current_order.tipo_pago == 'efectivo' && @current_order.vuelto.present? %>
                  <div class="col-md-4 mb-2">
                    <strong>Vuelto:</strong>
                    <div class="fw-bold text-info">$<%= sprintf("%.2f", @current_order.vuelto) %></div>
                  </div>
                <% end %>
              </div>
            </div>
          </div>
        <% end %>

        <!-- Total -->
        <div class="card bg-dark text-white">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
              <span class="fw-bold fs-5">Total del pedido:</span>
              <span class="fw-bold fs-4">$<%= sprintf("%.2f", @current_order.total) %></span>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>
<% end %>

<!-- Data para JavaScript -->
<script type="application/json" id="order-data">
<%= {
  orderId: @current_order&.id,
  orderStatus: @current_order&.status || 0,
  orderTotal: @current_order&.total || 0
}.to_json.html_safe %>
</script>

<script type="module">
  import "home";
</script>
 